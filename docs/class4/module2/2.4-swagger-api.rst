.. _2.4-swagger-api:

Exercise 2.4: Exploring the API
###############################

Objective
=========

Understand the API behind NGINX Instance Manager.

NGINX Instance Manager uses a simple API for almost all 
functions it provides.  We look to provide an API first 
in existing and new features.  This Exercise explores the 
provided API but does not exhaust options for the API.

You are highly encouraged to explore the API further and 
adapt the use of it for your own needs.

Guide
=====

Step 1: Explore the Swagger UI API Page
---------------------------------------

For this step, open the user interface for ``nginx-manager`` in 
the UDF dashboard.  You can select the ``ACCESS`` menu under 
``NGINX Manager Server`` and the ``INSTANCE MANAGER UI`` selection.
This will open the user interface in a new browser tab.

Navigate to the Inventory section and select the metrics icon 
on the far right for the ``Plus-Ubuntu`` instance.  The user 
interface should open a page with graphs similar to the one below.

.. image:: ./UI-nginx7-metrics.png

Step 2: Collect information on the instances
--------------------------------------------

On the UDF dashboard, navigate to the ``Grafana Server`` instance 
and select ``ACCESS`` and ``GRAFANA DASHBOARD``.

.. image:: ./UDF-grafana-access.png

Grafana will load and prompt for a username and password.  These 
credentials are located on the ``Details`` section of the 
``Grafana Server`` instance in UDF and also are listed below.

- username: ``admin``
- password: ``P@ssw0rd20``

.. image:: ./GRAFANA-login.png

You should be directed to an existing dashboard by default.

.. image:: ./GRAFANA-dashboard.png

Step 3: Get the configuration of an instance
--------------------------------------------

We have already created the data source in grafana. 
To understand how this was done, open the datasource menu on 
the left side grafana menu. 

.. image:: ./GRAFANA-datasource-menu.png

You should see a data source called ``nginx-manager`` already created.
If you were creating this new, you would click ``Add data source`` and 
select ``Prometheus`` as the type.

.. image:: ./GRAFANA-add-datasource.png

NGINX Instance Manager functions as a pure replacement for Prometheus in 
regards to metrics.  To see the details of the configuration click on 
the existing data source and look though the settings.

.. image:: ./GRAFANA-datasource-details.png

Close the datasource and navigate back to the Dashbaoard by 
navigating to ``Dashboards`` and ``Home``.

.. image:: ./GRAFANA-dashboard-home.png

Step 4: Analzye a configuration using the API
---------------------------------------------

You may want to generate some 400 and 200 hits by using the UDF 
dashboard and opening the websites the instance has.  This is optional 
but if there was no activity, there won't be on the graph either.

Let's use the drop down to select the Plus-Ubuntu instance.

.. image:: ./GRAFANA-plus-ubuntu.png

This dashboard is available during install and a sample file is placed 
in the ``/usr/share/doc/nginx-manager/grafana/`` directory on ``nginx-manager``.

.. code-block:: shell-session

    [centos@nginx-manager ~]$ ls -la /usr/share/doc/nginx-manager/grafana/
    total 28
    drwxr-xr-x. 2 root root    32 Mar 22 13:02 .
    drwxr-xr-x. 5 root root   149 Mar 22 13:02 ..
    -rw-r--r--. 1 root root 25919 Mar 19 19:51 nginx-manager.json

If you select the gear icon on top, you can see some of the properties we use.

Select Annotations and click ``Annotations & Alerts`` to see where we set the data source.

.. image:: ./GRAFANA-annotations.png

Selecting ``Variables`` from the menu also shows the selection dropdown we use.

.. image:: ./GRAFANA-variables.png

Click the ``Go Back`` button to return to the dashboard.
Try changing the time series and hostname.

Step 5: Push a configuration change using the API
-------------------------------------------------

Select the ``2xx Responses`` graph and open the editor for it.

.. image:: ./GRAFANA-edit-graph.png

.. image:: ./GRAFANA-edit-2xx.png

Look at the Queries used for the graph.
Query A is for the Open Source NGINX instances and also adjusts the counts so they are formatted as per hour.
Query B is the for NGINX Plus instances and pulls from the API without using the ``increase`` function.

We are using the metrics without conversion so we do not affect performance.

Click on the ``Metrics`` dropdown on query A to see other metrics.
You can select additional metrics and create your own graphs as you desire.

.. image:: ./GRAFANA-other-metrics.png


